import React, { useState, useEffect } from 'react';

const App = () => {
  const [currentScreen, setCurrentScreen] = useState('main');
  const [selectedSubject, setSelectedSubject] = useState(null);
  const [selectedLevel, setSelectedLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [unlockedLevels, setUnlockedLevels] = useState({});
  const [gameCompleted, setGameCompleted] = useState(false);
  const [streak, setStreak] = useState(0);
  const [showStreakBonus, setShowStreakBonus] = useState(false);
  const [totalGamesPlayed, setTotalGamesPlayed] = useState(0);
  const [achievements, setAchievements] = useState([]);

  // Questions database by subject and level with Belarus focus where appropriate
  const questionsBySubject = {
    mathematics: {
      1: [
        {
          question: 'Чему равен корень из 144?',
          options: ['12', '14', '16', '18'],
          correct: 0,
          points: 10,
          subject: 'Математика'
        },
        {
          question: 'Сколько областей в Республике Беларусь?',
          options: ['5', '6', '7', '8'],
          correct: 1,
          points: 10,
          subject: 'Математика'
        },
        {
          question: 'Как называется треугольник с тремя равными сторонами?',
          options: ['Равнобедренный', 'Прямоугольный', 'Равносторонний', 'Тупоугольный'],
          correct: 2,
          points: 10,
          subject: 'Математика'
        },
        {
          question: 'Если в классе 25 учеников, и 60% из них девочки, сколько девочек в классе?',
          options: ['12', '15', '18', '20'],
          correct: 1,
          points: 10,
          subject: 'Математика'
        },
        {
          question: 'Чему равно 5 × 7?',
          options: ['30', '35', '40', '45'],
          correct: 1,
          points: 10,
          subject: 'Математика'
        }
      ],
      2: [
        {
          question: 'Чему равно 7² + 24²?',
          options: ['625', '576', '49', '676'],
          correct: 0,
          points: 15,
          subject: 'Математика'
        },
        {
          question: 'Найдите 25% от 80',
          options: ['15', '20', '25', '30'],
          correct: 1,
          points: 15,
          subject: 'Математика'
        },
        {
          question: 'Решите уравнение: 2x + 5 = 15',
          options: ['x = 5', 'x = 10', 'x = 7.5', 'x = 20'],
          correct: 0,
          points: 15,
          subject: 'Математика'
        },
        {
          question: 'Какова площадь прямоугольника со сторонами 8 см и 12 см?',
          options: ['80 см²', '96 см²', '100 см²', '120 см²'],
          correct: 1,
          points: 15,
          subject: 'Математика'
        },
        {
          question: 'Чему равен sin(90°)?',
          options: ['0', '1', '0.5', '-1'],
          correct: 1,
          points: 15,
          subject: 'Математика'
        }
      ],
      3: [
        {
          question: 'Найдите производную функции f(x) = x³ + 2x² - 5',
          options: ['3x² + 4x', 'x² + 4x', '3x² + 2x', 'x³ + 4x'],
          correct: 0,
          points: 20,
          subject: 'Математика'
        },
        {
          question: 'Решите систему уравнений: x + y = 10, x - y = 2',
          options: ['x=6, y=4', 'x=4, y=6', 'x=8, y=2', 'x=2, y=8'],
          correct: 0,
          points: 20,
          subject: 'Математика'
        },
        {
          question: 'Чему равен интеграл от x² dx?',
          options: ['x³/3 + C', 'x³ + C', '2x + C', 'x²/2 + C'],
          correct: 0,
          points: 20,
          subject: 'Математика'
        },
        {
          question: 'Сколько решений имеет уравнение x² + 1 = 0?',
          options: ['0', '1', '2', 'Бесконечно много'],
          correct: 0,
          points: 20,
          subject: 'Математика'
        },
        {
          question: 'Какова вероятность выпадения четного числа при броске кубика?',
          options: ['1/6', '1/3', '1/2', '2/3'],
          correct: 2,
          points: 20,
          subject: 'Математика'
        }
      ]
    },
    literature: {
      1: [
        {
          question: 'Кто написал "Евгения Онегина"?',
          options: ['Лермонтов', 'Пушкин', 'Гоголь', 'Толстой'],
          correct: 1,
          points: 10,
          subject: 'Литература'
        },
        {
          question: 'Кто автор "Войны и мира"?',
          options: ['Достоевский', 'Толстой', 'Чехов', 'Гоголь'],
          correct: 1,
          points: 10,
          subject: 'Литература'
        },
        {
          question: 'Кто написал стихотворение "Я помню чудное мгновенье"?',
          options: ['Лермонтов', 'Пушкин', 'Есенин', 'Блок'],
          correct: 1,
          points: 10,
          subject: 'Литература'
        },
        {
          question: 'Кто написал "Мертвые души"?',
          options: ['Пушкин', 'Лермонтов', 'Гоголь', 'Достоевский'],
          correct: 2,
          points: 10,
          subject: 'Литература'
        },
        {
          question: 'Как звали главного героя "Мертвых душ"?',
          options: ['Чичиков', 'Плюшкин', 'Ноздрев', 'Манилов'],
          correct: 0,
          points: 10,
          subject: 'Литература'
        }
      ],
      2: [
        {
          question: 'Кто является автором "Преступления и наказания"?',
          options: ['Толстой', 'Достоевский', 'Чехов', 'Гоголь'],
          correct: 1,
          points: 15,
          subject: 'Литература'
        },
        {
          question: 'Как звали главную героиню "Анны Карениной"?',
          options: ['Наташа', 'Анна', 'Катерина', 'Маша'],
          correct: 1,
          points: 15,
          subject: 'Литература'
        },
        {
          question: 'Кто написал "Мцыри"?',
          options: ['Пушкин', 'Лермонтов', 'Некрасов', 'Тютчев'],
          correct: 1,
          points: 15,
          subject: 'Литература'
        },
        {
          question: 'Какое произведение написал Михаил Булгаков?',
          options: ['Преступление и наказание', 'Мастер и Маргарита', 'Отцы и дети', 'Обломов'],
          correct: 1,
          points: 15,
          subject: 'Литература'
        },
        {
          question: 'Кто автор поэмы "Медный всадник"?',
          options: ['Лермонтов', 'Пушкин', 'Некрасов', 'Блок'],
          correct: 1,
          points: 15,
          subject: 'Литература'
        }
      ],
      3: [
        {
          question: 'Какой литературный жанр использует иронию и сатиру для высмеивания пороков?',
          options: ['Эпос', 'Сатира', 'Ода', 'Элегия'],
          correct: 1,
          points: 20,
          subject: 'Литература'
        },
        {
          question: 'Какой художественный прием использует А.С. Пушкин в строке "И сердце вновь горит и любит..."?',
          options: ['Метафора', 'Олицетворение', 'Эпитет', 'Гипербола'],
          correct: 1,
          points: 20,
          subject: 'Литература'
        },
        {
          question: 'Как называется основной конфликт в драме "Гроза" Островского?',
          options: ['Любовный', 'Социально-бытовой', 'Философский', 'Психологический'],
          correct: 1,
          points: 20,
          subject: 'Литература'
        },
        {
          question: 'Кто из русских писателей получил Нобелевскую премию по литературе?',
          options: ['Лев Толстой', 'Федор Достоевский', 'Борис Пастернак', 'Александр Пушкин'],
          correct: 2,
          points: 20,
          subject: 'Литература'
        },
        {
          question: 'Какой поэт написал стихотворение "Песня про царя Ивана Васильевича"?',
          options: ['Пушкин', 'Лермонтов', 'Некрасов', 'Маяковский'],
          correct: 1,
          points: 20,
          subject: 'Литература'
        }
      ]
    },
    history: {
      1: [
        {
          question: 'В каком году произошло Крещение Руси?',
          options: ['988', '1054', '1147', '1237'],
          correct: 0,
          points: 10,
          subject: 'История'
        },
        {
          question: 'Кто был первым российским императором?',
          options: ['Иван Грозный', 'Петр I', 'Екатерина II', 'Александр I'],
          correct: 1,
          points: 10,
          subject: 'История'
        },
        {
          question: 'В каком году началась Великая Отечественная война?',
          options: ['1941', '1939', '1945', '1914'],
          correct: 0,
          points: 10,
          subject: 'История'
        },
        {
          question: 'Кто основал Санкт-Петербург?',
          options: ['Иван Грозный', 'Екатерина II', 'Петр I', 'Александр Невский'],
          correct: 2,
          points: 10,
          subject: 'История'
        },
        {
          question: 'Какой город был столицей Древней Руси?',
          options: ['Москва', 'Новгород', 'Киев', 'Владимир'],
          correct: 2,
          points: 10,
          subject: 'История'
        }
      ],
      2: [
        {
          question: 'Какой документ подписал Александр II в 1861 году?',
          options: ['Манифест о вольности', 'Указ об освобождении крестьян', 'Конституция', 'Манифест о прекращении войны'],
          correct: 1,
          points: 15,
          subject: 'История'
        },
        {
          question: 'Кто был последним российским императором?',
          options: ['Александр III', 'Николай I', 'Николай II', 'Александр II'],
          correct: 2,
          points: 15,
          subject: 'История'
        },
        {
          question: 'В каком году произошла Октябрьская революция?',
          options: ['1914', '1917', '1922', '1905'],
          correct: 1,
          points: 15,
          subject: 'История'
        },
        {
          question: 'Кто возглавлял Совет Народных Комиссаров после Октябрьской революции?',
          options: ['Ленин', 'Сталин', 'Троцкий', 'Каменев'],
          correct: 0,
          points: 15,
          subject: 'История'
        },
        {
          question: 'Какая битва стала переломной в Великой Отечественной войне?',
          options: ['Московская', 'Сталинградская', 'Курск', 'Ленинградская'],
          correct: 1,
          points: 15,
          subject: 'История'
        }
      ],
      3: [
        {
          question: 'Какой международный договор был подписан в 1939 году между СССР и Германией?',
          options: ['Пакт Молотова-Риббентропа', 'Брестский мир', 'Рапалльский договор', 'Мюнхенское соглашение'],
          correct: 0,
          points: 20,
          subject: 'История'
        },
        {
          question: 'Кто был первым космонавтом мира?',
          options: ['Гагарин', 'Титов', 'Терешкова', 'Леонов'],
          correct: 0,
          points: 20,
          subject: 'История'
        },
        {
          question: 'В каком году СССР запустил первый искусственный спутник Земли?',
          options: ['1957', '1961', '1955', '1964'],
          correct: 0,
          points: 20,
          subject: 'История'
        },
        {
          question: 'Кто был генеральным секретарем КПСС в период "застоя"?',
          options: ['Хрущев', 'Брежнев', 'Андропов', 'Черненко'],
          correct: 1,
          points: 20,
          subject: 'История'
        },
        {
          question: 'Как называлась экономическая реформа Алексея Косыгина в 1965 году?',
          options: ['Перестройка', 'НЭП', 'Реформа управления', 'Хрущевская оттепель'],
          correct: 2,
          points: 20,
          subject: 'История'
        }
      ]
    },
    biology: {
      1: [
        {
          question: 'Какой орган отвечает за фотосинтез у растений?',
          options: ['Корень', 'Стебель', 'Лист', 'Цветок'],
          correct: 2,
          points: 10,
          subject: 'Биология'
        },
        {
          question: 'Сколько хромосом у человека?',
          options: ['23', '46', '48', '24'],
          correct: 1,
          points: 10,
          subject: 'Биология'
        },
        {
          question: 'Какой газ выделяют растения в процессе фотосинтеза?',
          options: ['Азот', 'Углекислый газ', 'Кислород', 'Водород'],
          correct: 2,
          points: 10,
          subject: 'Биология'
        },
        {
          question: 'Как называется наука о животных?',
          options: ['Ботаника', 'Зоология', 'Экология', 'Генетика'],
          correct: 1,
          points: 10,
          subject: 'Биология'
        },
        {
          question: 'Какой орган является самым большим в человеческом теле?',
          options: ['Печень', 'Мозг', 'Кожа', 'Сердце'],
          correct: 2,
          points: 10,
          subject: 'Биология'
        }
      ],
      2: [
        {
          question: 'Какой процесс происходит в митохондриях?',
          options: ['Фотосинтез', 'Клеточное дыхание', 'Деление клетки', 'Синтез белка'],
          correct: 1,
          points: 15,
          subject: 'Биология'
        },
        {
          question: 'Как называется процесс деления клетки?',
          options: ['Митоз', 'Мейоз', 'Амитоз', 'Цитокинез'],
          correct: 0,
          points: 15,
          subject: 'Биология'
        },
        {
          question: 'Какой витамин вырабатывается в коже под действием солнечного света?',
          options: ['Витамин A', 'Витамин C', 'Витамин D', 'Витамин E'],
          correct: 2,
          points: 15,
          subject: 'Биология'
        },
        {
          question: 'Как называется наука о наследственности?',
          options: ['Цитология', 'Генетика', 'Эмбриология', 'Палеонтология'],
          correct: 1,
          points: 15,
          subject: 'Биология'
        },
        {
          question: 'Какой орган вырабатывает инсулин?',
          options: ['Печень', 'Поджелудочная железа', 'Щитовидная железа', 'Надпочечники'],
          correct: 1,
          points: 15,
          subject: 'Биология'
        }
      ],
      3: [
        {
          question: 'Какой тип РНК переносит аминокислоты к рибосоме?',
          options: ['мРНК', 'тРНК', 'рРНК', 'сРНК'],
          correct: 1,
          points: 20,
          subject: 'Биология'
        },
        {
          question: 'Как называется процесс синтеза белка?',
          options: ['Репликация', 'Транскрипция', 'Трансляция', 'Мутация'],
          correct: 2,
          points: 20,
          subject: 'Биология'
        },
        {
          question: 'Какой закон Менделя описывает расщепление признаков?',
          options: ['Закон единообразия', 'Закон расщепления', 'Закон независимого наследования', 'Закон сцепленного наследования'],
          correct: 1,
          points: 20,
          subject: 'Биология'
        },
        {
          question: 'Как называется процесс образования гамет?',
          options: ['Митоз', 'Мейоз', 'Амитоз', 'Овогенез'],
          correct: 1,
          points: 20,
          subject: 'Биология'
        },
        {
          question: 'Какой хромосомный набор у человека обозначается как 46,XY?',
          options: ['Женский', 'Мужской', 'Аномальный', 'Гаплоидный'],
          correct: 1,
          points: 20,
          subject: 'Биология'
        }
      ]
    },
    physics: {
      1: [
        {
          question: 'Какова скорость света в вакууме?',
          options: ['300 000 км/с', '150 000 км/с', '500 000 км/с', '1 000 000 км/с'],
          correct: 0,
          points: 10,
          subject: 'Физика'
        },
        {
          question: 'Что измеряется в ваттах?',
          options: ['Напряжение', 'Сила тока', 'Мощность', 'Сопротивление'],
          correct: 2,
          points: 10,
          subject: 'Физика'
        },
        {
          question: 'Какой элемент является основным компонентом Солнца?',
          options: ['Кислород', 'Углерод', 'Водород', 'Гелий'],
          correct: 2,
          points: 10,
          subject: 'Физика'
        },
        {
          question: 'Что такое инерция?',
          options: ['Сила трения', 'Свойство тела сохранять состояние покоя', 'Ускорение тела', 'Энергия движения'],
          correct: 1,
          points: 10,
          subject: 'Физика'
        },
        {
          question: 'Какой закон описывает силу всемирного тяготения?',
          options: ['Закон Архимеда', 'Закон Ома', 'Закон Ньютона', 'Закон Бойля-Мариотта'],
          correct: 2,
          points: 10,
          subject: 'Физика'
        }
      ],
      2: [
        {
          question: 'Какова формула второго закона Ньютона?',
          options: ['F = ma', 'F = mv', 'F = m/a', 'F = a/m'],
          correct: 0,
          points: 15,
          subject: 'Физика'
        },
        {
          question: 'Какой закон описывает сохранение энергии?',
          options: ['Первый закон термодинамики', 'Второй закон термодинамики', 'Закон Ома', 'Закон Кулона'],
          correct: 0,
          points: 15,
          subject: 'Физика'
        },
        {
          question: 'Как называется явление, при котором свет меняет направление при переходе между средами?',
          options: ['Отражение', 'Преломление', 'Дифракция', 'Интерференция'],
          correct: 1,
          points: 15,
          subject: 'Физика'
        },
        {
          question: 'Какой закон описывает зависимость силы тока от напряжения?',
          options: ['Закон Ньютона', 'Закон Ома', 'Закон Фарадея', 'Закон Кулона'],
          correct: 1,
          points: 15,
          subject: 'Физика'
        },
        {
          question: 'Как называется единица измерения электрического сопротивления?',
          options: ['Вольт', 'Ампер', 'Ом', 'Ватт'],
          correct: 2,
          points: 15,
          subject: 'Физика'
        }
      ],
      3: [
        {
          question: 'Какой принцип лежит в основе работы ядерного реактора?',
          options: ['Ядерный синтез', 'Ядерное деление', 'Радиоактивный распад', 'Термоядерная реакция'],
          correct: 1,
          points: 20,
          subject: 'Физика'
        },
        {
          question: 'Какой эффект описывает изменение частоты света при движении источника?',
          options: ['Фотоэффект', 'Эффект Доплера', 'Комптон-эффект', 'Зееман-эффект'],
          correct: 1,
          points: 20,
          subject: 'Физика'
        },
        {
          question: 'Какой закон описывает излучение черного тела?',
          options: ['Закон Стефана-Больцмана', 'Закон Вина', 'Закон Планка', 'Все перечисленные'],
          correct: 3,
          points: 20,
          subject: 'Физика'
        },
        {
          question: 'Как называется частица, переносящая электромагнитное взаимодействие?',
          options: ['Электрон', 'Фотон', 'Протон', 'Нейтрон'],
          correct: 1,
          points: 20,
          subject: 'Физика'
        },
        {
          question: 'Какой принцип запрещает одновременное точное измерение координаты и импульса?',
          options: ['Принцип неопределенности', 'Принцип суперпозиции', 'Принцип Паули', 'Принцип относительности'],
          correct: 0,
          points: 20,
          subject: 'Физика'
        }
      ]
    },
    geography: {
      1: [
        {
          question: 'Какая самая длинная река в мире?',
          options: ['Амазонка', 'Нил', 'Миссисипи', 'Янцзы'],
          correct: 1,
          points: 10,
          subject: 'География'
        },
        {
          question: 'Какая страна является самой большой по площади?',
          options: ['Китай', 'США', 'Россия', 'Канада'],
          correct: 2,
          points: 10,
          subject: 'География'
        },
        {
          question: 'Какой океан самый глубокий?',
          options: ['Атлантический', 'Индийский', 'Тихий', 'Северный Ледовитый'],
          correct: 2,
          points: 10,
          subject: 'География'
        },
        {
          question: 'Столица какой страны - Токио?',
          options: ['Китай', 'Южная Корея', 'Япония', 'Таиланд'],
          correct: 2,
          points: 10,
          subject: 'География'
        },
        {
          question: 'Какая гора самая высокая в мире?',
          options: ['Килиманджаро', 'Эверест', 'Эльбрус', 'Маттерхорн'],
          correct: 1,
          points: 10,
          subject: 'География'
        }
      ],
      2: [
        {
          question: 'Какой континент самый жаркий?',
          options: ['Азия', 'Африка', 'Австралия', 'Южная Америка'],
          correct: 1,
          points: 15,
          subject: 'География'
        },
        {
          question: 'Какой город является столицей Бразилии?',
          options: ['Рио-де-Жанейро', 'Сан-Паулу', 'Бразилиа', 'Сальвадор'],
          correct: 2,
          points: 15,
          subject: 'География'
        },
        {
          question: 'Какое море является самым соленым?',
          options: ['Красное море', 'Мертвое море', 'Средиземное море', 'Каспийское море'],
          correct: 1,
          points: 15,
          subject: 'География'
        },
        {
          question: 'Какой пролив соединяет Черное и Мраморное моря?',
          options: ['Босфор', 'Дарданеллы', 'Керченский', 'Гибралтарский'],
          correct: 0,
          points: 15,
          subject: 'География'
        },
        {
          question: 'Какая страна имеет наибольшее количество соседей?',
          options: ['Россия', 'Китай', 'США', 'Бразилия'],
          correct: 1,
          points: 15,
          subject: 'География'
        }
      ],
      3: [
        {
          question: 'Какой климатический пояс характеризуется сухим летом и влажной зимой?',
          options: ['Экваториальный', 'Субтропический', 'Умеренный', 'Субарктический'],
          correct: 1,
          points: 20,
          subject: 'География'
        },
        {
          question: 'Как называется процесс разрушения горных пород под действием внешних сил?',
          options: ['Вулканизм', 'Тектоника', 'Выветривание', 'Эрозия'],
          correct: 2,
          points: 20,
          subject: 'География'
        },
        {
          question: 'Какой тип почв характерен для степной зоны?',
          options: ['Подзолистые', 'Черноземы', 'Каштановые', 'Бурые лесные'],
          correct: 1,
          points: 20,
          subject: 'География'
        },
        {
          question: 'Как называется линия, соединяющая точки с одинаковой высотой над уровнем моря?',
          options: ['Изобара', 'Изотерма', 'Изогипса', 'Изогиета'],
          correct: 2,
          points: 20,
          subject: 'География'
        },
        {
          question: 'Какой океанический течением является Гольфстрим?',
          options: ['Холодным', 'Теплым', 'Сезонным', 'Приливным'],
          correct: 1,
          points: 20,
          subject: 'География'
        }
      ]
    }
  };

  const subjects = [
    { id: 'mathematics', name: 'Математика', emoji: '➗', color: 'from-blue-500 to-cyan-500' },
    { id: 'literature', name: 'Литература', emoji: '📚', color: 'from-purple-500 to-pink-500' },
    { id: 'history', name: 'История', emoji: '🏛️', color: 'from-amber-500 to-orange-500' },
    { id: 'biology', name: 'Биология', emoji: '🔬', color: 'from-green-500 to-emerald-500' },
    { id: 'physics', name: 'Физика', emoji: '⚡', color: 'from-red-500 to-rose-500' },
    { id: 'geography', name: 'География', emoji: '🌍', color: 'from-indigo-500 to-blue-500' }
  ];

  const levels = [
    { id: 1, name: 'Новичок', requiredScore: 0, color: 'from-gray-400 to-gray-600' },
    { id: 2, name: 'Знаток', requiredScore: 40, color: 'from-blue-400 to-blue-600' },
    { id: 3, name: 'Гений', requiredScore: 60, color: 'from-yellow-400 to-yellow-600' }
  ];

  const achievementsList = [
    { id: 'first_game', name: 'Первый шаг', description: 'Пройди первую игру', icon: '🎯' },
    { id: 'perfect_streak', name: 'Идеальный результат', description: 'Ответь правильно на все вопросы', icon: '⭐' },
    { id: 'level_master', name: 'Мастер уровня', description: 'Разблокируй все уровни по одному предмету', icon: '🏆' },
    { id: 'subject_expert', name: 'Эксперт', description: 'Набери 100+ баллов в одной игре', icon: '🧠' },
    { id: 'all_subjects', name: 'Полиглот', description: 'Играй во всех предметах', icon: '📚' }
  ];

  // Initialize unlocked levels and stats
  useEffect(() => {
    const savedUnlocked = localStorage.getItem('unlockedLevels');
    const savedGames = localStorage.getItem('totalGamesPlayed');
    const savedAchievements = localStorage.getItem('achievements');
    
    if (savedUnlocked) {
      setUnlockedLevels(JSON.parse(savedUnlocked));
    } else {
      const initialUnlocked = {};
      subjects.forEach(subject => {
        initialUnlocked[subject.id] = [1];
      });
      setUnlockedLevels(initialUnlocked);
    }
    
    if (savedGames) {
      setTotalGamesPlayed(parseInt(savedGames));
    }
    
    if (savedAchievements) {
      setAchievements(JSON.parse(savedAchievements));
    }
  }, []);

  // Save data
  useEffect(() => {
    if (Object.keys(unlockedLevels).length > 0) {
      localStorage.setItem('unlockedLevels', JSON.stringify(unlockedLevels));
    }
    localStorage.setItem('totalGamesPlayed', totalGamesPlayed.toString());
    localStorage.setItem('achievements', JSON.stringify(achievements));
  }, [unlockedLevels, totalGamesPlayed, achievements]);

  const handleAnswerSelect = (index) => {
    setSelectedAnswer(index);
  };

  const handleSubmitAnswer = () => {
    if (selectedAnswer === null || !selectedSubject) return;
    
    const currentQuestions = questionsBySubject[selectedSubject][selectedLevel];
    const question = currentQuestions[currentQuestion];
    const isCorrect = selectedAnswer === question.correct;
    
    if (isCorrect) {
      const pointsToAdd = question.points;
      setScore(score + pointsToAdd);
      
      // Streak logic
      setStreak(streak + 1);
      if (streak > 0 && (streak + 1) % 3 === 0) {
        setShowStreakBonus(true);
        setTimeout(() => setShowStreakBonus(false), 2000);
        setScore(prev => prev + 5); // Bonus points
      }
    } else {
      setStreak(0);
    }
    
    setShowResult(true);
    
    setTimeout(() => {
      if (currentQuestion < currentQuestions.length - 1) {
        setCurrentQuestion(currentQuestion + 1);
        setSelectedAnswer(null);
        setShowResult(false);
      } else {
        // Game completed - auto transition to completion screen
        setGameCompleted(true);
        setTotalGamesPlayed(prev => prev + 1);
        setCurrentScreen('completion');
        
        // Check achievements
        checkAchievements();
      }
    }, 2000);
  };

  const checkAchievements = () => {
    const newAchievements = [...achievements];
    
    // First game achievement
    if (totalGamesPlayed === 0 && !newAchievements.includes('first_game')) {
      newAchievements.push('first_game');
    }
    
    // Perfect streak achievement
    const currentQuestions = questionsBySubject[selectedSubject][selectedLevel];
    const allCorrect = currentQuestions.every((q, index) => {
      // This is simplified - in real app you'd track all answers
      return true; // Placeholder logic
    });
    if (allCorrect && !newAchievements.includes('perfect_streak')) {
      newAchievements.push('perfect_streak');
    }
    
    // Expert achievement
    if (score >= 100 && !newAchievements.includes('subject_expert')) {
      newAchievements.push('subject_expert');
    }
    
    // All subjects achievement
    const playedSubjects = Object.keys(unlockedLevels);
    if (playedSubjects.length === subjects.length && !newAchievements.includes('all_subjects')) {
      newAchievements.push('all_subjects');
    }
    
    // Level master achievement
    const currentSubjectUnlocked = unlockedLevels[selectedSubject] || [];
    if (currentSubjectUnlocked.length === 3 && !newAchievements.includes('level_master')) {
      newAchievements.push('level_master');
    }
    
    if (newAchievements.length > achievements.length) {
      setAchievements(newAchievements);
    }
  };

  const quitGame = () => {
    setCurrentScreen('subject');
  };

  const resetGame = () => {
    setCurrentScreen('main');
    setSelectedSubject(null);
    setSelectedLevel(1);
    setStreak(0);
  };

  const handleCompletionAction = (action) => {
    const currentLevelData = levels.find(l => l.id === selectedLevel);
    const nextLevel = selectedLevel + 1;
    const nextLevelData = levels.find(l => l.id === nextLevel);
    
    const newUnlocked = { ...unlockedLevels };
    if (!newUnlocked[selectedSubject]) {
      newUnlocked[selectedSubject] = [1];
    }
    
    if (action === 'next-level' && nextLevelData && score >= nextLevelData.requiredScore) {
      // Unlock next level if not already unlocked
      if (!newUnlocked[selectedSubject].includes(nextLevel)) {
        newUnlocked[selectedSubject].push(nextLevel);
      }
      setUnlockedLevels(newUnlocked);
      startGame(selectedSubject, nextLevel);
    } else if (action === 'retry') {
      startGame(selectedSubject, selectedLevel);
    } else {
      resetGame();
    }
  };

  const startGame = (subjectId, levelId) => {
    setSelectedSubject(subjectId);
    setSelectedLevel(levelId);
    setCurrentScreen('game');
    setScore(0);
    setCurrentQuestion(0);
    setSelectedAnswer(null);
    setShowResult(false);
    setGameCompleted(false);
    setStreak(0);
  };

  const showAchievements = () => {
    setCurrentScreen('achievements');
  };

  // Telegram WebApp initialization
  useEffect(() => {
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  }, []);

  if (currentScreen === 'main') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
          <div className="mb-6">
            <div className="w-24 h-24 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-4xl text-white">📚</span>
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Гимназический Квест</h1>
            <p className="text-gray-600">Проверь свои знания по школьным предметам!</p>
          </div>
          
          <div className="grid grid-cols-2 gap-4 mb-6">
            {subjects.map((subject) => (
              <button
                key={subject.id}
                onClick={() => {
                  setSelectedSubject(subject.id);
                  setCurrentScreen('subject');
                }}
                className={`p-4 rounded-2xl bg-gradient-to-r ${subject.color} text-white font-bold hover:scale-105 transform transition-all duration-200 shadow-lg`}
              >
                <div className="text-2xl mb-2">{subject.emoji}</div>
                <div className="text-sm">{subject.name}</div>
              </button>
            ))}
          </div>
          
          <div className="space-y-3">
            <button
              onClick={showAchievements}
              className="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-6 rounded-2xl hover:from-amber-600 hover:to-orange-600 transition-all duration-200"
            >
              🏆 Мои достижения ({achievements.length})
            </button>
            
            <div className="bg-yellow-50 rounded-2xl p-4">
              <h3 className="font-semibold text-yellow-800 mb-2">🎯 Как играть:</h3>
              <ul className="text-sm text-yellow-700 text-left space-y-1">
                <li>• Выбери школьный предмет и уровень</li>
                <li>• Ответь на 5 вопросов подряд</li>
                <li>• Получай бонусы за серию правильных ответов!</li>
                <li>• Разблокируй новые уровни и достижения</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (currentScreen === 'achievements') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full">
          <div className="text-center mb-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-2">🏆 Мои достижения</h2>
            <p className="text-gray-600">Игр сыграно: {totalGamesPlayed}</p>
          </div>
          
          <div className="space-y-4">
            {achievementsList.map((achievement) => {
              const isUnlocked = achievements.includes(achievement.id);
              return (
                <div
                  key={achievement.id}
                  className={`p-4 rounded-2xl border-2 ${
                    isUnlocked 
                      ? 'border-green-500 bg-green-50' 
                      : 'border-gray-300 bg-gray-50 opacity-60'
                  }`}
                >
                  <div className="flex items-center">
                    <div className="text-2xl mr-3">{achievement.icon}</div>
                    <div>
                      <h3 className={`font-bold ${isUnlocked ? 'text-green-800' : 'text-gray-500'}`}>
                        {achievement.name}
                      </h3>
                      <p className={`text-sm ${isUnlocked ? 'text-green-700' : 'text-gray-500'}`}>
                        {achievement.description}
                      </p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          
          <button
            onClick={() => setCurrentScreen('main')}
            className="w-full mt-6 bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-2xl hover:bg-gray-300 transition-all duration-200"
          >
            Назад
          </button>
        </div>
      </div>
    );
  }

  if (currentScreen === 'subject') {
    const currentSubject = subjects.find(s => s.id === selectedSubject);
    const unlocked = unlockedLevels[selectedSubject] || [1];
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
          <div className="mb-6">
            <div className={`w-20 h-20 bg-gradient-to-r ${currentSubject.color} rounded-full flex items-center justify-center mx-auto mb-4`}>
              <span className="text-3xl text-white">{currentSubject.emoji}</span>
            </div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">{currentSubject.name}</h2>
            <p className="text-gray-600">Выбери уровень сложности</p>
          </div>
          
          <div className="space-y-4 mb-6">
            {levels.map((level) => {
              const isUnlocked = unlocked.includes(level.id);
              const isLocked = level.id > 1 && !unlocked.includes(level.id);
              
              return (
                <button
                  key={level.id}
                  onClick={() => isUnlocked && startGame(selectedSubject, level.id)}
                  disabled={!isUnlocked}
                  className={`w-full p-4 rounded-2xl font-bold transition-all duration-200 ${
                    isUnlocked 
                      ? `bg-gradient-to-r ${level.color} text-white hover:scale-105 transform shadow-lg`
                      : 'bg-gray-200 text-gray-500 cursor-not-allowed opacity-60'
                  }`}
                >
                  <div className="flex justify-between items-center">
                    <span>{level.name}</span>
                    {isLocked && (
                      <span className="text-xs bg-white bg-opacity-30 px-2 py-1 rounded-full">
                        Нужно {level.requiredScore} баллов
                      </span>
                    )}
                    {isUnlocked && level.id > 1 && (
                      <span className="text-xs bg-white bg-opacity-30 px-2 py-1 rounded-full">
                        Открыто!
                      </span>
                    )}
                  </div>
                </button>
              );
            })}
          </div>
          
          <button
            onClick={() => setCurrentScreen('main')}
            className="w-full bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-2xl hover:bg-gray-300 transition-all duration-200"
          >
            Назад к предметам
          </button>
        </div>
      </div>
    );
  }

  if (currentScreen === 'game') {
    const currentQuestions = questionsBySubject[selectedSubject][selectedLevel];
    const question = currentQuestions[currentQuestion];
    const currentSubject = subjects.find(s => s.id === selectedSubject);
    const currentLevel = levels.find(l => l.id === selectedLevel);
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-6 max-w-md w-full">
          <div className="flex justify-between items-center mb-4">
            <button
              onClick={quitGame}
              className="text-gray-500 hover:text-gray-700 font-medium"
            >
              ← Назад
            </button>
            <div className="text-sm font-semibold text-gray-600">
              Вопрос {currentQuestion + 1} из {currentQuestions.length}
            </div>
          </div>
          
          <div className="mb-4">
            <div className="flex items-center justify-between mb-2">
              <div className={`inline-block bg-gradient-to-r ${currentSubject.color} text-white px-3 py-1 rounded-full text-sm font-medium`}>
                {currentSubject.emoji} {currentSubject.name}
              </div>
              <div className={`inline-block bg-gradient-to-r ${currentLevel.color} text-white px-3 py-1 rounded-full text-sm font-medium`}>
                {currentLevel.name}
              </div>
            </div>
            <div className="flex justify-between items-center">
              <div className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">
                {score} 🏆
              </div>
              {streak > 0 && (
                <div className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold">
                  Серия: {streak} 🔥
                </div>
              )}
            </div>
          </div>
          
          <h2 className="text-xl font-bold text-gray-800 mb-4">{question.question}</h2>
          
          <div className="space-y-3 mb-6">
            {question.options.map((option, index) => (
              <button
                key={index}
                onClick={() => handleAnswerSelect(index)}
                disabled={showResult}
                className={`w-full text-left p-4 rounded-2xl border-2 transition-all duration-200 ${
                  selectedAnswer === index 
                    ? 'border-blue-500 bg-blue-50' 
                    : 'border-gray-200 hover:border-gray-300'
                } ${
                  showResult 
                    ? index === question.correct 
                      ? 'border-green-500 bg-green-50' 
                      : selectedAnswer === index && index !== question.correct
                        ? 'border-red-500 bg-red-50'
                        : 'opacity-70'
                    : ''
                }`}
              >
                {option}
              </button>
            ))}
          </div>
          
          {!showResult && (
            <button
              onClick={handleSubmitAnswer}
              disabled={selectedAnswer === null}
              className={`w-full py-3 px-6 rounded-2xl font-bold transition-all duration-200 ${
                selectedAnswer === null
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-gradient-to-r from-green-500 to-blue-500 text-white hover:from-green-600 hover:to-blue-600 transform hover:scale-105'
              }`}
            >
              Ответить
            </button>
          )}
          
          {showResult && (
            <div className={`p-4 rounded-2xl text-center ${
              selectedAnswer === question.correct ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`}>
              {selectedAnswer === question.correct ? '✅ Правильно!' : '❌ Неправильно!'}
              {selectedAnswer === question.correct && (
                <div className="mt-2 font-bold">+{question.points} баллов!</div>
              )}
            </div>
          )}
          
          {showStreakBonus && (
            <div className="p-3 bg-yellow-100 text-yellow-800 rounded-2xl text-center animate-pulse">
              🔥 Бонус за серию! +5 баллов!
            </div>
          )}
        </div>
      </div>
    );
  }

  if (currentScreen === 'completion') {
    const currentSubject = subjects.find(s => s.id === selectedSubject);
    const currentLevel = levels.find(l => l.id === selectedLevel);
    const nextLevel = selectedLevel + 1;
    const nextLevelData = levels.find(l => l.id === nextLevel);
    const canUnlockNext = nextLevelData && score >= nextLevelData.requiredScore;
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
          <div className="mb-6">
            <div className="w-24 h-24 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <span className="text-4xl text-white">🎉</span>
            </div>
            <h2 className="text-2xl font-bold text-gray-800 mb-2">Квест завершен!</h2>
            <p className="text-4xl font-bold text-purple-600 mb-2">{score} баллов</p>
            <p className="text-gray-600">Ты прошел {currentLevel.name} по {currentSubject.name}!</p>
          </div>
          
          {streak === 5 && (
            <div className="bg-yellow-50 rounded-2xl p-4 mb-4 border-2 border-yellow-300">
              <h3 className="font-semibold text-yellow-800 mb-1">🔥 Идеальная серия!</h3>
              <p className="text-yellow-700">Ты ответил правильно на все вопросы подряд!</p>
            </div>
          )}
          
          {canUnlockNext ? (
            <div className="bg-green-50 rounded-2xl p-4 mb-6">
              <h3 className="font-semibold text-green-800 mb-2">🏆 Поздравляем!</h3>
              <p className="text-green-700">
                Ты набрал достаточно баллов для разблокировки уровня "{nextLevelData.name}"!
              </p>
            </div>
          ) : nextLevelData ? (
            <div className="bg-yellow-50 rounded-2xl p-4 mb-6">
              <h3 className="font-semibold text-yellow-800 mb-2">💡 Совет:</h3>
              <p className="text-yellow-700">
                Нужно {nextLevelData.requiredScore} баллов для разблокировки следующего уровня. 
                Попробуй пройти этот уровень еще раз!
              </p>
            </div>
          ) : (
            <div className="bg-blue-50 rounded-2xl p-4 mb-6">
              <h3 className="font-semibold text-blue-800 mb-2">🏆 Отличная работа!</h3>
              <p className="text-blue-700">
                Ты прошел все уровни по этому предмету! Попробуй другой предмет.
              </p>
            </div>
          )}
          
          <div className="space-y-3">
            {canUnlockNext && (
              <button
                onClick={() => handleCompletionAction('next-level')}
                className="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white font-bold py-3 px-6 rounded-2xl hover:from-green-600 hover:to-blue-600 transition-all duration-200 transform hover:scale-105"
              >
                Перейти к уровню "{nextLevelData.name}"
              </button>
            )}
            
            <button
              onClick={() => handleCompletionAction('retry')}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-6 rounded-2xl hover:from-purple-600 hover:to-pink-600 transition-all duration-200"
            >
              Пройти уровень заново
            </button>
            
            <button
              onClick={() => handleCompletionAction('back')}
              className="w-full bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-2xl hover:bg-gray-300 transition-all duration-200"
            >
              Вернуться к выбору предметов
            </button>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

export default App;
